<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MineStore Pro Dashboard</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #0b0e11;
        color: #ffffff;
      }

      /* Sidebar Styling */
      .sidebar-link {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        color: #8a8a93;
        border-radius: 8px;
        transition: all 0.3s;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        border-left: 3px solid transparent;
      }
      .sidebar-link:hover {
        background-color: #1a1a20;
        color: #ffffff;
      }
      .sidebar-link.active {
        background-color: #1a1a20;
        color: #ffffff;
        border-left: 3px solid #6366f1;
      }

      .sidebar-section {
        font-size: 0.75rem;
        color: #5a5a65;
        font-weight: 700;
        margin-top: 24px;
        margin-bottom: 8px;
        padding-left: 16px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Card Styling */
      .stat-card {
        background-color: #15151a;
        border-radius: 16px;
        padding: 24px;
        border: 1px solid #222228;
      }
      .icon-box {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
      }

      /* Utilitários */
      .hidden-view {
        display: none !important;
      }
      .text-accent {
        color: #818cf8;
      }
      .font-mono {
        font-family: "JetBrains Mono", monospace;
      }

      /* Animações */
      .animate-fade {
        animation: fadeIn 0.4s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Scrollbar Customizada */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #0b0e11;
      }
      ::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
    </style>
  </head>
  <body class="flex h-screen overflow-hidden">
    <aside
      class="w-72 bg-[#111116] border-r border-[#222] flex flex-col justify-between hidden md:flex"
    >
      <div class="p-6">
        <div class="flex items-center gap-4 mb-10">
          <div
            class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center font-bold text-xl shadow-lg shadow-indigo-500/20"
          >
            M
          </div>
          <div>
            <h1 class="font-bold text-white text-lg leading-tight">
              MineStore
            </h1>
            <span
              class="text-xs text-green-400 font-semibold flex items-center gap-1"
            >
              <span
                class="w-2 h-2 rounded-full bg-green-400 animate-pulse"
              ></span>
              Online
            </span>
          </div>
        </div>

        <nav class="space-y-1">
          <div class="sidebar-section">Geral</div>
          <a onclick="view('dash', this)" class="sidebar-link active"
            ><i class="fa-solid fa-chart-line w-5"></i> Visão Geral</a
          >
          <a onclick="view('stock', this)" class="sidebar-link"
            ><i class="fa-solid fa-boxes-stacked w-5"></i> Estoque</a
          >

          <div class="sidebar-section">Gerenciamento</div>
          <a onclick="view('users', this)" class="sidebar-link"
            ><i class="fa-solid fa-users-viewfinder w-5"></i> Usuários</a
          >
          <a class="sidebar-link opacity-50 cursor-not-allowed"
            ><i class="fa-solid fa-file-invoice-dollar w-5"></i> Transações</a
          >

          <div class="sidebar-section">Sistema</div>
          <a class="sidebar-link"
            ><i class="fa-solid fa-terminal w-5"></i> Logs (Ver Console)</a
          >
        </nav>
      </div>

      <div class="p-6 border-t border-[#222]">
        <div
          class="flex items-center gap-3 p-3 rounded-xl bg-[#1a1a20] hover:bg-[#222] cursor-pointer transition"
        >
          <img
            id="guildIcon"
            src="https://cdn.discordapp.com/embed/avatars/0.png"
            class="w-10 h-10 rounded-full"
          />
          <div class="flex-1 overflow-hidden">
            <p class="text-sm font-bold truncate" id="serverNameSide">
              Carregando...
            </p>
            <p class="text-xs text-gray-500">Admin Panel v3.0</p>
          </div>
        </div>
      </div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-[#0b0e11] p-8 md:p-12 relative">
      <div class="md:hidden flex justify-between items-center mb-8">
        <h1 class="text-2xl font-bold">Dashboard</h1>
        <button class="text-gray-400">
          <i class="fa-solid fa-bars text-xl"></i>
        </button>
      </div>

      <div id="view-dash" class="view-content animate-fade">
        <header class="flex justify-between items-end mb-10">
          <div>
            <h2 class="text-3xl font-bold text-white">Dashboard Overview</h2>
            <p class="text-gray-500 mt-1">
              Bem-vindo de volta! Aqui está o resumo do seu servidor.
            </p>
          </div>
          <div class="text-right hidden md:block">
            <p class="text-sm text-gray-500">Receita Total</p>
            <p class="text-2xl font-bold text-green-400">
              R$ <span id="revenue">0.00</span>
            </p>
          </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div
            class="stat-card hover:border-indigo-500/50 transition duration-300"
          >
            <div class="flex justify-between items-start">
              <div>
                <h3
                  class="text-gray-400 text-xs font-bold uppercase tracking-wider"
                >
                  Mensagens (Hoje)
                </h3>
                <p class="text-3xl font-bold mt-2 text-white" id="msgCount">
                  0
                </p>
              </div>
              <div class="icon-box bg-[#6366f1]/10 text-[#818cf8]">
                <i class="fa-solid fa-comment-dots"></i>
              </div>
            </div>
          </div>

          <div
            class="stat-card hover:border-green-500/50 transition duration-300"
          >
            <div class="flex justify-between items-start">
              <div>
                <h3
                  class="text-gray-400 text-xs font-bold uppercase tracking-wider"
                >
                  Entradas (Hoje)
                </h3>
                <p class="text-3xl font-bold mt-2 text-white" id="joinCount">
                  0
                </p>
              </div>
              <div class="icon-box bg-green-500/10 text-green-400">
                <i class="fa-solid fa-user-plus"></i>
              </div>
            </div>
          </div>

          <div
            class="stat-card hover:border-red-500/50 transition duration-300"
          >
            <div class="flex justify-between items-start">
              <div>
                <h3
                  class="text-gray-400 text-xs font-bold uppercase tracking-wider"
                >
                  Saídas (Hoje)
                </h3>
                <p class="text-3xl font-bold mt-2 text-white" id="leaveCount">
                  0
                </p>
              </div>
              <div class="icon-box bg-red-500/10 text-red-400">
                <i class="fa-solid fa-user-minus"></i>
              </div>
            </div>
          </div>

          <div
            class="stat-card hover:border-purple-500/50 transition duration-300"
          >
            <div class="flex justify-between items-start">
              <div>
                <h3
                  class="text-gray-400 text-xs font-bold uppercase tracking-wider"
                >
                  Membros Totais
                </h3>
                <p class="text-3xl font-bold mt-2 text-white" id="totalMembers">
                  0
                </p>
              </div>
              <div class="icon-box bg-purple-500/10 text-purple-400">
                <i class="fa-solid fa-users"></i>
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <div class="stat-card h-[350px] relative">
            <h3
              class="text-gray-400 text-sm font-semibold mb-6 flex items-center gap-2"
            >
              <span class="w-2 h-2 rounded-full bg-indigo-500"></span> Atividade
              de Mensagens (7 Dias)
            </h3>
            <div class="absolute inset-x-6 bottom-6 top-16">
              <canvas id="msgChart"></canvas>
            </div>
          </div>

          <div class="stat-card h-[350px] relative">
            <h3
              class="text-gray-400 text-sm font-semibold mb-6 flex items-center gap-2"
            >
              <span class="w-2 h-2 rounded-full bg-green-500"></span> Fluxo de
              Membros (7 Dias)
            </h3>
            <div class="absolute inset-x-6 bottom-6 top-16">
              <canvas id="memberChart"></canvas>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="stat-card col-span-2 flex flex-col h-80">
            <div
              class="flex justify-between items-center mb-4 border-b border-[#222] pb-3"
            >
              <h3
                class="text-gray-400 text-xs font-bold uppercase tracking-wider"
              >
                <i class="fa-solid fa-terminal mr-2"></i> System Console
              </h3>
              <div class="flex items-center gap-2">
                <span
                  class="w-2 h-2 bg-green-500 rounded-full animate-pulse"
                ></span>
                <span class="text-xs text-green-500 font-mono">LIVE</span>
              </div>
            </div>
            <div
              id="console"
              class="flex-1 overflow-y-auto font-mono text-xs space-y-1 text-gray-400 pr-2"
            >
              <div class="text-gray-600">
                > Inicializando sistema de logs...
              </div>
            </div>
          </div>

          <div class="stat-card h-80 flex flex-col">
            <h3
              class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-4"
            >
              <i class="fa-solid fa-trophy mr-2 text-yellow-500"></i> Top
              Vendedores
            </h3>
            <div class="flex-1 overflow-y-auto pr-2">
              <ul id="topSellersList" class="space-y-3"></ul>
            </div>
          </div>
        </div>
      </div>

      <div id="view-stock" class="view-content hidden-view animate-fade">
        <header class="mb-8 flex justify-between items-center">
          <div>
            <h2 class="text-3xl font-bold text-white">Gerenciar Estoque</h2>
            <p class="text-gray-500 mt-1">
              Visualize e remova contas disponíveis para venda.
            </p>
          </div>
          <div class="bg-[#1a1a20] px-4 py-2 rounded-lg border border-[#222]">
            <span class="text-gray-400 text-sm">Total Itens:</span>
            <span class="text-white font-bold ml-2" id="stockCountBadge"
              >0</span
            >
          </div>
        </header>

        <div class="stat-card overflow-hidden p-0">
          <table class="w-full text-left text-sm text-gray-400">
            <thead
              class="bg-[#1a1a20] text-xs uppercase text-gray-200 font-bold tracking-wider"
            >
              <tr>
                <th class="p-5">Nick da Conta</th>
                <th class="p-5">Preço</th>
                <th class="p-5">Vendedor</th>
                <th class="p-5">Data</th>
                <th class="p-5 text-right">Ação</th>
              </tr>
            </thead>
            <tbody id="stockTable" class="divide-y divide-[#222]"></tbody>
          </table>
        </div>
      </div>

      <div id="view-users" class="view-content hidden-view animate-fade">
        <header class="mb-8">
          <h2 class="text-3xl font-bold text-white">Inspecionar Usuário</h2>
          <p class="text-gray-500 mt-1">
            Verifique o histórico de vendas e reputação de qualquer membro.
          </p>
        </header>

        <div class="flex gap-4 mb-8">
          <div class="relative flex-1 max-w-xl">
            <i
              class="fa-solid fa-magnifying-glass absolute left-4 top-4 text-gray-500"
            ></i>
            <input
              type="text"
              id="userIdInput"
              placeholder="Cole o ID do Discord aqui (Ex: 123456789...)"
              class="w-full bg-[#15151a] border border-[#222] p-3 pl-12 rounded-xl text-white outline-none focus:border-indigo-500 transition shadow-lg"
            />
          </div>
          <button
            onclick="searchUser()"
            class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 rounded-xl font-bold transition shadow-lg shadow-indigo-600/20"
          >
            Buscar Dados
          </button>
        </div>

        <div
          id="userResult"
          class="hidden-view stat-card border-l-4 border-indigo-500"
        >
          <div class="flex items-center gap-6 mb-8 border-b border-[#222] pb-6">
            <img
              id="uAvatar"
              src=""
              class="w-20 h-20 rounded-full border-4 border-[#222] shadow-xl"
            />
            <div>
              <h3 id="uName" class="text-2xl font-bold text-white">
                Nome do Usuário
              </h3>
              <div class="flex gap-3 mt-2">
                <span
                  class="bg-indigo-500/10 text-indigo-400 px-3 py-1 rounded text-xs font-bold border border-indigo-500/20"
                >
                  <i class="fa-solid fa-cart-shopping mr-1"></i>
                  <span id="uSales">0</span> Vendas
                </span>
                <span
                  class="bg-yellow-500/10 text-yellow-500 px-3 py-1 rounded text-xs font-bold border border-yellow-500/20"
                >
                  <i class="fa-solid fa-star mr-1"></i>
                  <span id="uRep">--</span> Reputação
                </span>
              </div>
            </div>
          </div>

          <h4
            class="text-xs font-bold text-gray-500 uppercase mb-4 tracking-wider"
          >
            Histórico de Transações
          </h4>
          <div
            id="uHistory"
            class="space-y-2 max-h-80 overflow-y-auto pr-2"
          ></div>
        </div>
      </div>
    </main>

    <script>
      // --- NAVEGAÇÃO DE ABAS ---
      function view(id, btn) {
        document
          .querySelectorAll(".view-content")
          .forEach((d) => d.classList.add("hidden-view"));
        document.getElementById("view-" + id).classList.remove("hidden-view");

        document
          .querySelectorAll(".sidebar-link")
          .forEach((el) => el.classList.remove("active"));
        if (btn) btn.classList.add("active");
      }

      // --- CONFIGURAÇÃO DOS GRÁFICOS (Chart.js) ---
      Chart.defaults.color = "#6b7280";
      Chart.defaults.font.family = "'Inter', sans-serif";

      let msgChartInstance = null;
      let memberChartInstance = null;

      async function initCharts(data) {
        // GRÁFICO 1: Mensagens (Onda Roxa)
        const ctx1 = document.getElementById("msgChart").getContext("2d");
        const gradient1 = ctx1.createLinearGradient(0, 0, 0, 300);
        gradient1.addColorStop(0, "rgba(99, 102, 241, 0.4)"); // Roxo Brilhante
        gradient1.addColorStop(1, "rgba(99, 102, 241, 0)");

        if (msgChartInstance) msgChartInstance.destroy();

        msgChartInstance = new Chart(ctx1, {
          type: "line",
          data: {
            labels: data.charts.messages.labels,
            datasets: [
              {
                label: "Messages",
                data: data.charts.messages.data,
                borderColor: "#818cf8",
                backgroundColor: gradient1,
                borderWidth: 2,
                tension: 0.4, // Curva suave
                fill: true,
                pointRadius: 3,
                pointBackgroundColor: "#15151a",
                pointBorderColor: "#818cf8",
                pointBorderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { mode: "index", intersect: false },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: "#222", drawBorder: false },
              },
              x: { grid: { display: false } },
            },
          },
        });

        // GRÁFICO 2: Membros (Barras Verde/Vermelho)
        const ctx2 = document.getElementById("memberChart").getContext("2d");
        if (memberChartInstance) memberChartInstance.destroy();

        memberChartInstance = new Chart(ctx2, {
          type: "bar",
          data: {
            labels: data.charts.members.labels,
            datasets: [
              {
                label: "Entradas",
                data: data.charts.members.joins,
                backgroundColor: "#22c55e",
                borderRadius: 4,
                barPercentage: 0.6,
              },
              {
                label: "Saídas",
                data: data.charts.members.leaves,
                backgroundColor: "#ef4444",
                borderRadius: 4,
                barPercentage: 0.6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "top",
                align: "end",
                labels: { boxWidth: 8, usePointStyle: true },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: "#222", drawBorder: false },
              },
              x: { grid: { display: false } },
            },
          },
        });
      }

      // --- CARREGAMENTO DE DADOS ---
      async function loadData() {
        try {
          const res = await fetch("/api/stats");
          const data = await res.json();

          // Cards Topo
          document.getElementById("msgCount").innerText =
            data.cards.messagesToday;
          document.getElementById("joinCount").innerText =
            data.cards.joinsToday;
          document.getElementById("leaveCount").innerText =
            data.cards.leavesToday;
          document.getElementById("totalMembers").innerText =
            data.cards.totalMembers;
          document.getElementById("revenue").innerText = data.cards.revenue;

          // Sidebar Info
          document.getElementById("serverNameSide").innerText = data.serverName;
          document.getElementById("guildIcon").src =
            data.avatar || "https://cdn.discordapp.com/embed/avatars/0.png";

          // Gráficos
          initCharts(data);

          // Top Vendedores Lista
          const sellersList = document.getElementById("topSellersList");
          sellersList.innerHTML = data.topSellers
            .map(
              (s, i) => `
                    <li class="flex items-center justify-between p-3 rounded-lg bg-[#111116] border border-[#222]">
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-gray-600 text-lg w-4">#${
                              i + 1
                            }</span>
                            <img src="${
                              s.avatar ||
                              "https://cdn.discordapp.com/embed/avatars/0.png"
                            }" class="w-8 h-8 rounded-full">
                            <span class="font-semibold text-gray-300 text-sm">${
                              s.name
                            }</span>
                        </div>
                        <span class="text-indigo-400 font-bold text-xs bg-indigo-500/10 px-2 py-1 rounded">${
                          s.count
                        } vendas</span>
                    </li>
                `
            )
            .join("");

          // Tabela de Estoque
          document.getElementById("stockCountBadge").innerText =
            data.inventory.length;
          const stockTable = document.getElementById("stockTable");
          stockTable.innerHTML = data.inventory.length
            ? data.inventory
                .map(
                  (i) => `
                    <tr class="hover:bg-[#1a1a20] transition group">
                        <td class="p-5 font-bold text-white">${i.nick}</td>
                        <td class="p-5 text-green-400 font-mono">R$ ${i.price}</td>
                        <td class="p-5 flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-gray-500"></div> ${i.seller}
                        </td>
                        <td class="p-5 text-gray-500 text-xs">${i.date}</td>
                        <td class="p-5 text-right">
                            <button onclick="del('${i.nick}')" class="text-red-500 hover:text-white bg-red-500/10 hover:bg-red-600 px-3 py-1.5 rounded text-xs font-bold transition">DELETAR</button>
                        </td>
                    </tr>
                `
                )
                .join("")
            : '<tr><td colspan="5" class="p-8 text-center text-gray-500">Nenhum item em estoque.</td></tr>';
        } catch (e) {
          console.error("Erro API", e);
        }
      }

      // --- CONSOLE LOGS ---
      async function loadLogs() {
        if (
          document.getElementById("view-dash").classList.contains("hidden-view")
        )
          return; // Economiza recurso se não estiver vendo

        try {
          const res = await fetch("/api/logs");
          const logs = await res.json();
          const consoleDiv = document.getElementById("console");

          // Diff simples para não redesenhar tudo se não mudou
          const html = logs
            .map((l) => {
              let color = "text-blue-400";
              let icon = '<i class="fa-solid fa-info-circle"></i>';
              if (l.level === "ERROR") {
                color = "text-red-500";
                icon = '<i class="fa-solid fa-circle-exclamation"></i>';
              }
              if (l.level === "WARN") {
                color = "text-yellow-500";
                icon = '<i class="fa-solid fa-triangle-exclamation"></i>';
              }
              if (l.level === "SALES") {
                color = "text-green-400";
                icon = '<i class="fa-solid fa-money-bill-wave"></i>';
              }
              if (l.level === "CMD") {
                color = "text-purple-400";
                icon = '<i class="fa-solid fa-terminal"></i>';
              }

              return `<div class="font-mono text-xs border-l-2 border-[#222] pl-3 py-1 hover:bg-[#1a1a20] transition">
                        <span class="text-gray-600 mr-2">[${l.timestamp}]</span>
                        <span class="${color} font-bold w-16 inline-block">${icon} ${l.level}</span>
                        <span class="text-gray-400">${l.message}</span>
                    </div>`;
            })
            .join("");

          if (consoleDiv.innerHTML !== html) consoleDiv.innerHTML = html;
        } catch (e) {}
      }

      // --- BUSCA USUÁRIO ---
      async function searchUser() {
        const id = document.getElementById("userIdInput").value;
        if (!id) return;

        try {
          const res = await fetch(`/api/user/${id}`);
          if (!res.ok) throw new Error();
          const user = await res.json();

          document.getElementById("userResult").classList.remove("hidden-view");
          document.getElementById("uName").innerText = user.username;
          document.getElementById("uAvatar").src = user.avatar;
          document.getElementById("uSales").innerText = user.salesCount;
          document.getElementById("uRep").innerText =
            user.reputation?.average || "0.0";

          const hist = document.getElementById("uHistory");
          hist.innerHTML = user.history.length
            ? user.history
                .map(
                  (h) => `
                    <div class="p-3 bg-[#111116] rounded-lg border border-[#222] flex justify-between items-center mb-2">
                        <div>
                            <span class="${
                              h.status === "VENDIDO"
                                ? "text-green-400"
                                : "text-blue-400"
                            } font-bold text-xs uppercase tracking-wider">[${
                    h.status
                  }]</span>
                            <span class="text-white font-bold ml-2">${
                              h.nick
                            }</span>
                        </div>
                        <span class="text-gray-400 font-mono text-xs">R$ ${
                          h.price
                        } • ${new Date(h.date).toLocaleDateString()}</span>
                    </div>
                `
                )
                .join("")
            : '<div class="text-gray-500 text-center p-4">Nenhuma venda encontrada.</div>';
        } catch {
          alert("Usuário não encontrado ou erro na API.");
        }
      }

      // --- DELETAR ---
      async function del(nick) {
        if (
          confirm(`Tem certeza que deseja apagar ${nick}? Isso é irreversível.`)
        ) {
          await fetch(`/api/item/${nick}`, { method: "DELETE" });
          loadData();
        }
      }

      // Loops de atualização
      setInterval(loadData, 5000);
      setInterval(loadLogs, 2000);
      loadData();
      loadLogs();
    </script>
  </body>
</html>
